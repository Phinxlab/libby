import e from"@babel/runtime/regenerator";import t from"@babel/runtime/helpers/asyncToGenerator";import n from"@babel/runtime/helpers/classCallCheck";import r from"@babel/runtime/helpers/createClass";import i from"lodash";import s from"@babel/runtime/helpers/extends";import a from"@babel/runtime/helpers/toConsumableArray";import o from"@babel/runtime/helpers/possibleConstructorReturn";import u from"@babel/runtime/helpers/getPrototypeOf";import c from"@babel/runtime/helpers/assertThisInitialized";import h from"@babel/runtime/helpers/inherits";import l from"react";import f from"@babel/runtime/helpers/get";var p=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{save:!1,remove:!1},i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;n(this,e),this.parameter=t,this.operation=r,this.target=i,this.name=s,this.error=null,this.data=[]}return r(e,[{key:"done",value:function(e){this.isResultset()?(this.data=e,this.target.propagateDAO(this.name,e)):this.target.forceUpdate()}},{key:"failed",value:function(e){this.error=e,this.target.forceUpdate()}},{key:"commandHasStarted",value:function(){this.target.stateHasChanged()}},{key:"isResultset",value:function(){return!this.operation.save&&!this.operation.remove}},{key:"isSave",value:function(){return this.operation.save}},{key:"isRemove",value:function(){return this.operation.remove}}]),e}(),v=function(){function e(t,r){n(this,e),this.name=t,this.pk=r,this.listeners=[]}return r(e,[{key:"addStoreListener",value:function(e){this.listeners.push(e)}},{key:"removeStoreListener",value:function(e){i.pull(this.listeners,e)}},{key:"notify",value:function(){var e=this;this.listeners.forEach((function(t){t.storeHasChanged(e.name)}))}}]),e}(),g=function(){function i(e){n(this,i),this.selected=!1;this.getQuery=e,this.config={fields:{},aggregations:[],groups:{}}}var s;return r(i,[{key:"toURL",value:function(){var e=this.config.fields,t=this.config.aggregations,n=this.config.groups,r=[];return isArray(e)&&e.forEach((function(e){r.push("aggregate.field[".concat(e,"]=").concat(e))})),t.forEach((function(e){r.push("aggregate.function[".concat(e.field,"]=").concat(e.operator))})),isArray(n)&&n.forEach((function(e){r.push("aggregate.group[".concat(e,"]=").concat(e))})),r.push("aggregated=true"),r}},{key:"count",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"countof".concat(e),n=i.Operator.COUNT;return this.config.aggregations.push({operator:n,field:e,as:t}),this}},{key:"sum",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sumof".concat(e),n=i.Operator.SUM;return this.config.aggregations.push({operator:n,field:e,as:t}),this}},{key:"avg",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"avgof".concat(e),n=i.Operator.AVG;return this.config.aggregations.push({operator:n,field:e,as:t}),this}},{key:"min",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"mninof".concat(e),n=i.Operator.MIN;return this.config.aggregations.push({operator:n,field:e,as:t}),this}},{key:"max",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"maxof".concat(e),n=i.Operator.MAX;return this.config.aggregations.push({operator:n,field:e,as:t}),this}},{key:"groupBy",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.config.groups=t,this.config.fields=t,this}},{key:"run",value:(s=t(e.mark((function t(){var n;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.getQuery(),e.abrupt("return",n.run.bind(n)());case 2:case"end":return e.stop()}}),t,this)}))),function(){return s.apply(this,arguments)})}]),i}();g.Operator={SUM:"sum",AVG:"avg",MAX:"max",MIN:"min",COUNT:"count"};var y=function(){function i(e){var t=this;n(this,i),this.dao=e,this.aggregated=!1,this._aggregate=new g((function(){return t}));this._config={filter:{},order:[],limit:{from:0,to:0}},this.groupActive=0,this.group=0}var s;return r(i,[{key:"aggregate",value:function(){if(this._aggregated)throw new Error("You can't aggregate multiple times");return this._aggregated=!0,this._config.aggregate=this._aggregate,this._aggregate}},{key:"between",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,s=i.RANGE;return this._config.filter[Symbol(r)]={field:e,value:t,to:n,type:s},this}},{key:"equals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.EQUALS;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"notEquals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.NOT_EQUALS;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"higher",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.HIGHER;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"higherOrEquals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.HIGHEROREQUALS;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"lower",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.LOWER;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"lowerOrEquals",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.LOWEROREQUALS;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"orderBy",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return this._config.order.push({alias:n,field:e,direction:t}),this}},{key:"includes",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.INCLUDES;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"starts",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.STARTS;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"ends",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=i.ENDS;return this._config.filter[Symbol(n)]={field:e,value:t,type:r},this}},{key:"limit",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return this._config.limit={from:e,to:t},this}},{key:"groupStart",value:function(){this.group++,this.groupActive++;var e=i.GROUP_START;return this._config.filter[Symbol("group_start")]={field:"group_start",value:"group_start",type:e},this}},{key:"groupEnd",value:function(){this.group--,this.groupActive--;var e=i.GROUP_END;return this._config.filter[Symbol("group_end")]={field:"group_end",value:"group_end",type:e},this}},{key:"and",value:function(){var e=i.AND;return this._config.filter[Symbol("and")]={field:"and",value:"and",type:e},this}},{key:"or",value:function(){var e=i.OR;return this._config.filter[Symbol("or")]={field:"or",value:"or",type:e},this}},{key:"run",value:(s=t(e.mark((function t(n){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===this.group){e.next=2;break}throw Error("Unbalanced selections");case 2:return e.abrupt("return",this.dao.find(this.config,n));case 3:case"end":return e.stop()}}),t,this)}))),function(e){return s.apply(this,arguments)})},{key:"config",get:function(){return this._config}}]),i}();y.OR=Symbol("or"),y.AND=Symbol("and"),y.GROUP_START=Symbol("group_start"),y.GROUP_END=Symbol("group_end"),y.NOT_EQUALS=Symbol("not_equals"),y.RANGE=Symbol("range"),y.EQUALS=Symbol("equals"),y.LOWER=Symbol("lower"),y.LOWEROREQUALS=Symbol("lowerorequals"),y.HIGHER=Symbol("higher"),y.HIGHEROREQUALS=Symbol("higherorequals"),y.INCLUDES=Symbol("includes"),y.STARTS=Symbol("starts"),y.ENDS=Symbol("ends");var m=function(){function i(e,t){n(this,i),this.name=e,this.pk=t,this.resultsetCommands={},this.workers=0,this.errors={}}var s,a,o,u,c,h;return r(i,[{key:"execute",value:(h=t(e.mark((function t(n){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.workers++,delete this.errors[n.name],n.isResultset()&&(this.resultsetCommands[n.name]=n),n.commandHasStarted();case 4:case"end":return e.stop()}}),t,this)}))),function(e){return h.apply(this,arguments)})},{key:"query",value:function(){return new y(this)}},{key:"find",value:(c=t(e.mark((function t(n){var r,s,a=this,o=arguments;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=o.length>1&&void 0!==o[1]?o[1]:i.DEFAULT_RESULTSET,s=this.createCommand(n,{save:!1,remove:!1},this,r),e.abrupt("return",this.execute(s).then((function(e){return a.done(s,e),e})).catch((function(e){a.failed(s,e)})));case 3:case"end":return e.stop()}}),t,this)}))),function(e){return c.apply(this,arguments)})},{key:"findAll",value:(u=t(e.mark((function t(){var n,r=arguments;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:i.DEFAULT_RESULTSET,e.abrupt("return",this.find(this.query().config,n));case 3:case"end":return e.stop()}}),t,this)}))),function(){return u.apply(this,arguments)})},{key:"save",value:(o=t(e.mark((function t(n){var r,i=this;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.createCommand(n,{save:!0,remove:!1},this),e.abrupt("return",this.execute(r).then((function(e){return i.done(r,e),e})).catch((function(e){throw i.failed(r,e),new Error(e)})));case 2:case"end":return e.stop()}}),t,this)}))),function(e){return o.apply(this,arguments)})},{key:"resetErrors",value:function(e){e?delete this.errors[e]:this.errors={}}},{key:"clean",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i.DEFAULT_RESULTSET;delete this.resultsetCommands[e]}},{key:"remove",value:(a=t(e.mark((function t(n){var r,i=this;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.createCommand(n,{save:!1,remove:!0},this),e.abrupt("return",this.execute(r).then((function(e){return i.done(r,e),e})).catch((function(e){throw new Error(e)})));case 2:case"end":return e.stop()}}),t,this)}))),function(e){return a.apply(this,arguments)})},{key:"findByPk",value:(s=t(e.mark((function t(n){var r,s,a=arguments;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]?a[2]:i.DEFAULT_RESULTSET,(s=new y(this)).equals(this.pk,n),e.abrupt("return",this.find(s.config,r));case 6:case"end":return e.stop()}}),t,this)}))),function(e){return s.apply(this,arguments)})},{key:"createCommand",value:function(e,t,n,r){return new p(e,t,n,r)}},{key:"done",value:function(e,t){this.workers--,e.done(t),(e.isSave()||e.isRemove())&&this.strategy.notify()}},{key:"failed",value:function(e,t){this.workers--,this.errors[e.name]=t,t[e.name]=t,e.failed(t)}},{key:"getResultsets",value:function(){var e=Object.keys(this.resultsetCommands);return 1===e.length?this.resultsetCommands[i.DEFAULT_RESULTSET].data:0===e.length?[]:new Proxy(this.resultsetCommands,{get:function(e,t){return e[t].data}})}},{key:"refresh",value:function(){var e=this;Object.keys(this.resultsetCommands).forEach((function(t){try{var n=e.resultsetCommands[t];e.execute(n).then((function(t){e.done(n,t)})).catch((function(t){e.failed(n,t)}))}catch(e){console.log("FALLLLEEEEEEEEE")}}))}}]),i}();m.DEFAULT_RESULTSET="_default";var d=new(function(){function e(){n(this,e),this.daos={},this._sessions={}}return r(e,[{key:"register",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t||(t=e.createDAO()),this.daos[e.name]={dao:t,strategy:e}}},{key:"get",value:function(e){return this.daos[e]}},{key:"addSessionStrategy",value:function(e){this.sessions[e.name]=e,e.recoverSession()}},{key:"getSessionStrategy",value:function(e){return this.sessions[e]}},{key:"sessions",get:function(){return this._sessions}},{key:"listSessions",get:function(){return i.toArray(this._sessions)}}]),e}());function k(e,t){return function(){for(var t=arguments.length,i=new Array(t),f=0;f<t;f++)i[f]=arguments[f];return(function(t){function f(e){var t;n(this,f),t=o(this,u(f).call(this,e));var r=c(t);return t.state={libby:new Proxy({},{findErrors:function(){var e=[];return Object.keys(r.state.libby).forEach((function(t){var n=r.state.libby[t];n.name&&Object.keys(n.errors).length>0&&e.push.apply(e,a(Object.values(n.errors)))})),e},workingSession:function(){var e=0;return d.listSessions.forEach((function(t){e+=t.working})),e},workingDAO:function(){var e=0;return r.state&&Object.keys(r.state.libby).forEach((function(t){var n=r.state.libby[t];n.name&&(e+=n.workers)})),e},get:function(e,t){switch(t){case"workingDAO":return this.workingDAO()>0;case"workingSession":return this.workingSession()>0;case"working":return this.workingSession()+this.workingDAO()>0;case"hasErrors":return this.findErrors().length>0;case"errors":return this.findErrors();case"session":return new Proxy({},{set:function(e,t,n){var r=Object.keys(d.sessions);if(1===r.length){var i=d.sessions[r[0]];if(Reflect.has(i,t))return Reflect.set(i,t,n)}return Reflect.set(d.sessions,t,n)},get:function(e,t){var n=Object.keys(d.sessions);if(1===n.length){var r=d.sessions[n[0]];if(Reflect.has(r,t))return r[t]}return d.sessions[t]}})}return Reflect.get(e,t)}})},i.forEach((function(e){var n=new(0,d.get(e).dao);n.createCommand=function(e,n,r,i){return new p(e,n,c(t),i)},t.state.libby[e]=new Proxy(n,{get:function(e,t){return"data"===t?e.getResultsets():Reflect.get(e,t)}})})),t}return h(f,t),r(f,[{key:"componentWillMount",value:function(){var e=this;i.forEach((function(t){d.get(t).strategy.addStoreListener(e)})),Object.keys(d.sessions).forEach((function(t){d.sessions[t].addSessionListener(e)}))}},{key:"componentWillUnmount",value:function(){var e=this;i.forEach((function(t){d.get(t).strategy.removeStoreListener(e)})),Object.keys(d.sessions).forEach((function(t){d.sessions[t].removeSessionListener(e)}))}},{key:"newSessionState",value:function(e,t){this.state.libby.sessionChanged=!0,this.setState({libby:this.state.libby})}},{key:"storeHasChanged",value:function(e){this.state.libby[e].refresh()}},{key:"stateHasChanged",value:function(){this.forceUpdate()}},{key:"propagateDAO",value:function(e,t){this.state.libby.sessionChanged=!1,this.setState({libby:this.state.libby})}},{key:"render",value:function(){return l.createElement(e,s({libby:this.state.libby},this.props))}}]),f}(l.Component))}}var b=function(i){function s(e,t){var r;return n(this,s),(r=o(this,u(s).call(this,e,t))).strategy=d.get(e).strategy,r}var a,c,l,p;return h(s,m),r(s,[{key:"processResultset",value:(p=t(e.mark((function t(n){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.strategy.find(n.parameter));case 1:case"end":return e.stop()}}),t,this)}))),function(e){return p.apply(this,arguments)})},{key:"processChange",value:(l=t(e.mark((function t(n){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.strategy.save(n.parameter).then((function(e){return e})));case 1:case"end":return e.stop()}}),t,this)}))),function(e){return l.apply(this,arguments)})},{key:"processRemove",value:(c=t(e.mark((function t(n){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.strategy.remove(n.parameter).then((function(e){return e})));case 1:case"end":return e.stop()}}),t,this)}))),function(e){return c.apply(this,arguments)})},{key:"execute",value:(a=t(e.mark((function t(n){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(f(u(s.prototype),"execute",this).call(this,n),n.isSave()){e.next=7;break}if(!n.isRemove()){e.next=4;break}return e.abrupt("return",this.processRemove(n));case 4:return e.abrupt("return",this.processResultset(n));case 7:return e.abrupt("return",this.processChange(n));case 8:case"end":return e.stop()}}),t,this)}))),function(e){return a.apply(this,arguments)})}]),s}(),S={};S[y.RANGE]=function(e,t,n){return e>=t&&e<=n},S[y.LOWEROREQUALS]=function(e,t){return e<=t},S[y.LOWER]=function(e,t){return e<t},S[y.EQUALS]=function(e,t){return e===t},S[y.HIGHEROREQUALS]=function(e,t){return e>=t},S[y.HIGHER]=function(e,t){return e>t},S[y.INCLUDES]=function(e,t){return e.includes(t)},S[y.STARTS]=function(e,t){return e.startsWith(t)},S[y.ENDS]=function(e,t){return e.endsWith(t)};var E={asc:function(e){return function(t,n){return t[e]===n[e]?0:t[e]>n[e]?1:-1}},desc:function(e){return function(t,n){return t[e]===n[e]?0:t[e]<n[e]?1:-1}}},w=function(s){function a(e,t){var r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return n(this,a),(r=o(this,u(a).call(this,e,t))).setList(i),r}var c,l,f;return h(a,v),r(a,[{key:"find",value:(f=t(e.mark((function t(n){var r,i,s,a,o,u,c,h;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,0!==Object.keys(n).length){e.next=3;break}return e.abrupt("return",this.list);case 3:for(r=this.list,i=n.order,s=n.limit,a=[],o=0;o<r.length;o++)u=r[o],this.evaluate(u,n)&&a.push(u);for(s.from>0&&a.length>0&&(a=-1===s.to?a.slice(0,Math.min(a.length,s.from)):a.slice(s.from-1,Math.max(a.length,s.to))),c=0;c<i.length;c++)h=i[c],a=a.sort(E[h.direction](h.field));return e.abrupt("return",a);case 12:throw e.prev=12,e.t0=e.catch(0),new Error(e.t0);case 15:case"end":return e.stop()}}),t,this,[[0,12]])}))),function(e){return f.apply(this,arguments)})},{key:"evaluate",value:function(e,t){for(var n=t.filter,r=Object.keys(n),i=0;i<r.length;i++){var s=n[r[i]],a=e[s.field];if(!S[s.type](a,s.value,s.to))return!1}return!0}},{key:"guid",value:function(){function e(e){var t=(Math.random().toString(16)+"000000000").substr(2,8);return e?"-"+t.substr(0,4)+"-"+t.substr(4,4):t}return e()+e(!0)+e(!0)+e()}},{key:"setList",value:function(e){var t=this;this.map={},this._list=[],e.forEach((function(e){var n=i.cloneDeep(e);t._list.push(e),t.map[n[t.pk]]=n}))}},{key:"remove",value:(l=t(e.mark((function t(n){var r,s=this;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.list,i.remove(r,(function(e){return e[s.pk]===n[s.pk]})),this.setList(r),e.abrupt("return",n);case 4:case"end":return e.stop()}}),t,this)}))),function(e){return l.apply(this,arguments)})},{key:"save",value:(c=t(e.mark((function t(n){var r,s=this;return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(r=i.cloneDeep(n))[this.pk]?(this.map[r[this.pk]]=r,i.remove(this._list,(function(e){return e[s.pk]===r[s.pk]})),this._list.push(r)):(r[this.pk]=this.guid(),this.map[r[this.pk]]=r,this._list.push(r)),e.abrupt("return",i.cloneDeep(r));case 6:e.prev=6,e.t0=e.catch(0),console.error(e.t0);case 9:case"end":return e.stop()}}),t,this,[[0,6]])}))),function(e){return c.apply(this,arguments)})},{key:"createDAO",value:function(){var e=this;return(function(t){function r(){return n(this,r),o(this,u(r).call(this,e.name,e.pk))}return h(r,b),r}())}},{key:"list",get:function(){return i.cloneDeep(this._list)}}]),a}(),_=function(){function i(){n(this,i)}var s,a;return r(i,[{key:"perisist",value:(a=t(e.mark((function t(n){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),t)}))),function(e){return a.apply(this,arguments)})},{key:"clean",value:function(){}},{key:"retrieve",value:(s=t(e.mark((function t(){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null);case 1:case"end":return e.stop()}}),t)}))),function(){return s.apply(this,arguments)})}]),i}(),O=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(e,t){return null};n(this,e),this.mapper=t,this.fallback=r,this.extramapper=[]}return r(e,[{key:"addAttribute",value:function(e,t,n){return this.extramapper.push({name:e,mapper:t,child:n}),this}},{key:"mapField",value:function(e,t){var n=i.get(this.mapper,t),r=null;return i.isString(n)&&(r=i.get(e,n)),null==r&&(r=this.fallback(t,e)),r}},{key:"map",value:function(e,t,n){var r=this,i={};return n.concat(this.extramapper).forEach((function(e){"string"==typeof e?i[e]=r.mapField(t,e):i[e.name]=e.mapper.map(t[e.child])})),new e(i,t)}}]),e}(),R=function(){function e(t,r){n(this,e),this._nativerole=t,this.nativerole=r}return r(e,[{key:"hasPermissions",value:function(e){return!1}},{key:"id",get:function(){return this._nativerole.id}},{key:"name",get:function(){return this._nativerole.name}},{key:"native",get:function(){return this._nativerole}}]),e}(),L=["id","name"],A=function(e){function t(e,r){return n(this,t),o(this,u(t).call(this,e,r))}return h(t,O),r(t,[{key:"map",value:function(e){return f(u(t.prototype),"map",this).call(this,R,e,L)}}],[{key:"create",value:function(e,n){return new t(e,n)}}]),t}(),U=function(){function e(t,r){n(this,e),this._nativeuser=t,this.originaluser=r}return r(e,[{key:"isGuest",value:function(){return this._nativeuser.isGuest}},{key:"id",get:function(){return this._nativeuser.id}},{key:"native",get:function(){return this._nativeuser}},{key:"original",get:function(){return this.originaluser}},{key:"friendlyName",get:function(){return"".concat(this.name," ").concat(this.lastname)}},{key:"name",get:function(){return this.native.name}},{key:"lastname",get:function(){return this.native.lastname}},{key:"username",get:function(){return this._nativeuser.username}},{key:"role",get:function(){return new R(this._nativeuser.role)}}]),e}(),x=function(e){function t(){return n(this,t),o(this,u(t).call(this,{isGuest:!0,username:"guest",name:"guest",lastname:"",role:{name:"guest"}}))}return h(t,U),t}(),T=["isGuest","username","name","lastname","id"],D=function(e){function t(e,r){return n(this,t),o(this,u(t).call(this,e,r))}return h(t,O),r(t,[{key:"map",value:function(e){return f(u(t.prototype),"map",this).call(this,U,e,T)}}],[{key:"create",value:function(e,n,r,i){return new t(e,i).addAttribute("role",n,r)}}]),t}(),G=function(){function s(e){n(this,s),this.listeners=[],this.working=0,this._tokenmanager=new _,this._user=s.GUEST_USER,this.userMapper=null,this.lastMessage=null}var a,o;return r(s,[{key:"setUserMapper",value:function(e,t){this.userMapper=e,s.GUEST_USER=t}},{key:"acceptSession",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._user;this.startWorking(),this.notify(s.LOGGED,e)}},{key:"recoverSession",value:function(){this.startWorking()}},{key:"getLastMessage",value:function(){return this.lastMessage}},{key:"isLogged",value:function(){return this.state===s.NEW_SESSION&&!1===this.user.isGuest()||this.state===s.LOGGED}},{key:"init",value:function(){this.startWorking()}},{key:"startWorking",value:function(){var e=this;this.working++,this.listeners.forEach((function(t){t.newSessionState(s.WORKING,e.name)}))}},{key:"status",value:function(e){}},{key:"login",value:(o=t(e.mark((function t(n,r){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.startWorking();case 1:case"end":return e.stop()}}),t,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"logout",value:(a=t(e.mark((function t(){return e.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.startWorking();case 1:case"end":return e.stop()}}),t,this)}))),function(){return a.apply(this,arguments)})},{key:"addSessionListener",value:function(e){this.listeners.push(e)}},{key:"removeSessionListener",value:function(e){i.pull(this.listeners,e)}},{key:"notify",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s.GUEST_USER,r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";try{e===s.NEW_SESSION&&this.getTokenManager().persist(r),this.lastMessage=i,this.working--,this.state=e,this.user=n,this.listeners.forEach((function(n){n.newSessionState(e,t.name)}))}catch(e){this.working--,console.error(e)}}},{key:"getTokenManager",value:function(){return this._tokenmanager}},{key:"setTokenManager",value:function(e){return this._tokenmanager=e,this}},{key:"sessionHasExpired",value:function(){this.startWorking(),this.notify(s.EXPIRED,this.user)}},{key:"user",set:function(e){try{this.userMapper?this._user=this.userMapper.map(e):this._user=e}catch(e){console.error(e)}},get:function(){return this._user}},{key:"state",get:function(){return this._state||s.NO_SESSION},set:function(e){this._state=e}},{key:"name",get:function(){return"SessionStrategy"}}]),s}();G.LOGGED="LOGGED",G.NEW_SESSION="New session",G.FAILED_TO_LOGIN="Failed to get session",G.LOGOUT_SESSION="Logout session",G.NO_SESSION="No session",G.GUEST_USER=new x,G.WORKING="Working",G.EXPIRED="Expired";var N={Component:function(e){function t(e){return n(this,t),o(this,u(t).call(this,e))}return h(t,e),r(t,[{key:"componentDidUpdate",value:function(e,t,n){}},{key:"componentDidMount",value:function(){this.fetchData(this.libby)}},{key:"fetchData",value:function(e){}},{key:"reload",value:function(){this.fetchData(this.libby)}},{key:"draw",value:function(e){return l.createElement("h1",null,"Implement the method draw(libby) to render the screen")}},{key:"render",value:function(){return this.draw(this.libby)}},{key:"libby",get:function(){return this.props.libby}},{key:"working",get:function(){return this.props.working}}]),t}(l.Component),App:"LibbyApp"};export{m as DAO,p as DAOCommand,y as DAOQueryBuilder,d as Database,k as DatabaseConnector,v as StoreStrategy,b as MemoryDAO,w as MemoryStoreStrategy,_ as SessionStore,A as RoleMapper,D as UserMapper,G as SessionStrategy,N as Libby};
//# sourceMappingURL=rrpm.module.js.map
