!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@babel/runtime/helpers/objectSpread"),require("@babel/runtime/regenerator"),require("@babel/runtime/helpers/asyncToGenerator"),require("@babel/runtime/helpers/classCallCheck"),require("@babel/runtime/helpers/createClass"),require("@babel/runtime/helpers/defineProperty"),require("lodash/get"),require("@babel/runtime/helpers/possibleConstructorReturn"),require("@babel/runtime/helpers/getPrototypeOf"),require("@babel/runtime/helpers/get"),require("@babel/runtime/helpers/inherits"),require("lodash"),require("@phinxlab/libby-core-public")):"function"==typeof define&&define.amd?define(["exports","@babel/runtime/helpers/objectSpread","@babel/runtime/regenerator","@babel/runtime/helpers/asyncToGenerator","@babel/runtime/helpers/classCallCheck","@babel/runtime/helpers/createClass","@babel/runtime/helpers/defineProperty","lodash/get","@babel/runtime/helpers/possibleConstructorReturn","@babel/runtime/helpers/getPrototypeOf","@babel/runtime/helpers/get","@babel/runtime/helpers/inherits","lodash","@phinxlab/libby-core-public"],t):t((e=e||self).Libby={},e._objectSpread,e._regeneratorRuntime,e._asyncToGenerator,e._classCallCheck,e._createClass,e._defineProperty,e.get,e._possibleConstructorReturn,e._getPrototypeOf,e._get,e._inherits,e._,e.libbyCorePublic)}(this,(function(e,t,r,n,a,u,s,i,o,c,h,l,p,f){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n,a=a&&a.hasOwnProperty("default")?a.default:a,u=u&&u.hasOwnProperty("default")?u.default:u,s=s&&s.hasOwnProperty("default")?s.default:s,i=i&&i.hasOwnProperty("default")?i.default:i,o=o&&o.hasOwnProperty("default")?o.default:o,c=c&&c.hasOwnProperty("default")?c.default:c,h=h&&h.hasOwnProperty("default")?h.default:h,l=l&&l.hasOwnProperty("default")?l.default:l,p=p&&p.hasOwnProperty("default")?p.default:p;var d,y,v,b,g=function(e){function s(){return a(this,s),o(this,c(s).call(this))}var i,d,y,v;return l(s,e),u(s,null,[{key:"name",value:function(){return"rest"}}]),u(s,[{key:"recoverSession",value:(v=n(r.mark((function e(){var t;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h(c(s.prototype),"recoverSession",this).call(this),e.next=3,this.getTokenManager().retrieve();case 3:(t=e.sent)||this.notify(f.SessionStrategy.NO_SESSION),this.status(t);case 6:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"init",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"/platform/login",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"/platform/logout",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"/platform/status";return h(c(s.prototype),"init",this).call(this),O.defineHeader("x-libby-app",f.Libby.App),this.config={url:e,loginPath:t,logoutPath:r,statusPath:n},this.notify(f.SessionStrategy.NO_SESSION),this}},{key:"status",value:(y=n(r.mark((function e(t){var n=this;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h(c(s.prototype),"status",this).call(this,t),O.defineHeader("x-chino-token",t),e.abrupt("return",O.execute("".concat(this.config.statusPath),{},k.POST).then((function(e){var t=e.data,r=t.user;return r.isGuest=t.isGuest,n.notify(f.SessionStrategy.NEW_SESSION,r,e.headers["x-chino-token"]),e.data})).catch((function(e){console.log(e.message),O.removeHeader("x-chino-token"),n.notify(f.SessionStrategy.FAILED_TO_LOGIN,void 0,void 0,p.get(e,"rest.data","Unable to connect to server"))})));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"login",value:(d=n(r.mark((function e(n,a){var u,i,o=this,l=arguments;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=l.length>2&&void 0!==l[2]?l[2]:{},h(c(s.prototype),"login",this).call(this,n,a),i=t({nick:n,password:a},u),O.removeHeader("x-chino-token"),e.abrupt("return",O.execute("".concat(this.config.loginPath),i,k.POST,!0).then((function(e){var t=e.headers["x-chino-token"];O.defineHeader("x-chino-token",t);var r=e.data,n=r.user;return n.isGuest=r.isGuest,o.notify(f.SessionStrategy.NEW_SESSION,n,t),e.data})).catch((function(e){o.notify(f.SessionStrategy.FAILED_TO_LOGIN,void 0,void 0,p.get(e,"rest.data","Unable to connect to server"))})));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"getURL",value:function(e){return this.config.url+e}},{key:"logout",value:(i=n(r.mark((function e(){var t=this;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h(c(s.prototype),"logout",this).call(this),e.abrupt("return",O.execute("".concat(this.config.logoutPath),{},k.POST).then((function(e){O.removeHeader("x-chino-token"),t.getTokenManager().clean(),t.notify(f.SessionStrategy.NO_SESSION)})).catch((function(e){O.removeHeader("x-chino-token"),t.notify(f.SessionStrategy.FAILED_TO_LOGIN,void 0,void 0,p.get(e,"rest.data","Unable to connect to server"))})));case 2:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"name",get:function(){return"rest"}}]),s}(f.SessionStrategy),S=new g,k={};function m(e){return e.toString().indexOf("Network Error")>0?"Network connection to server has failed":e.toString().replace("Error:","")}k.PUT=Symbol("put"),k.POST=Symbol("post"),k.DELETE=Symbol("delete"),k.GET=Symbol("get"),d=k.PUT,y=k.POST,v=k.DELETE,b=k.GET;var O=new(function(){function e(){var t=this;a(this,e),s(this,"header",{"Content-Type":"application/json; charset=utf-8"}),s(this,d,function(){var e=n(r.mark((function e(n,a,u){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.executeHTTP("put",n,a,u));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()),s(this,y,function(){var e=n(r.mark((function e(n,a,u){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.executeHTTP("post",n,a,u));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()),s(this,v,function(){var e=n(r.mark((function e(n,a,u){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.executeHTTP("delete",n,a,u));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()),s(this,b,function(){var e=n(r.mark((function e(n,a,u){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.executeHTTP("get",n,a,u));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()),s(this,"validateResponse",(function(e,r){if(Object.keys(e).includes("x-chino-error")){var n=m(e["x-chino-error"]);throw t.createHTTPError(r,n,n)}}))}var o,c;return u(e,[{key:"createConfig",value:function(e,t,r){return"get"===e?{url:t,method:e,headers:this.header}:{url:t,method:e,body:JSON.stringify(r),headers:this.header}}},{key:"removeHeader",value:function(e){delete this.header[e]}},{key:"defineHeader",value:function(e,t){this.header[e]=t}},{key:"execute",value:(c=n(r.mark((function e(t,n,a){var u,s=arguments;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=s.length>3&&void 0!==s[3]&&s[3],e.abrupt("return",this[a](S.getURL(t),n,u));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return c.apply(this,arguments)})},{key:"executeHTTP",value:(o=n(r.mark((function e(n,a,u,s){var o,c,h,l,p,f;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(a,this.createConfig(n,a,u));case 3:return o=e.sent,c=o.headers.get("x-chino-token"),h=i(o,"headers.map","headers"),l=t({},h,{"x-chino-token":c}),p=o.status,this.validateResponse(l,p),e.prev=9,e.next=12,o.json();case 12:return f=e.sent,e.abrupt("return",{data:f,headers:l,status:p});case 16:return e.prev=16,e.t0=e.catch(9),e.abrupt("return",{headers:l,status:p});case 19:e.next=29;break;case 21:if(e.prev=21,e.t1=e.catch(0),console.log(e.t1),!i(e.t1,"rest")){e.next=28;break}throw e.t1;case 28:throw new Error(e.t1.toString(),m(e.t1));case 29:case"end":return e.stop()}}),e,this,[[0,21],[9,16]])}))),function(e,t,r,n){return o.apply(this,arguments)})},{key:"createHTTPError",value:function(e,t,r){var n=f.Database.getSessionStrategy(S.name),a=new Error("REST ERROR -> ".concat(e," with ").concat(t," at data ").concat(r),t);switch(e){case 412:n.sessionHasExpired()}return a.rest={code:e,text:t,data:r},a}}]),e}()),w=function(e){function t(e,r){var n;return a(this,t),(n=o(this,c(t).call(this,e,r))).strategy=f.Database.get(e).strategy,n}var s,i,p,d;return l(t,e),u(t,[{key:"processResultset",value:(d=n(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.strategy.find(t.parameter));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"processChange",value:(p=n(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.strategy.save(t.parameter).then((function(e){return e})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"processRemove",value:(i=n(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.strategy.remove(t.parameter).then((function(e){return e})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"execute",value:(s=n(r.mark((function e(n){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(h(c(t.prototype),"execute",this).call(this,n),n.isSave()){e.next=7;break}if(!n.isRemove()){e.next=4;break}return e.abrupt("return",this.processRemove(n));case 4:return e.abrupt("return",this.processResultset(n));case 7:return e.abrupt("return",this.processChange(n));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})}]),t}(f.DAO),x={};x[f.DAOQueryBuilder.LOWEROREQUALS]="lowerorequals",x[f.DAOQueryBuilder.LOWER]="lower",x[f.DAOQueryBuilder.EQUALS]="equals",x[f.DAOQueryBuilder.NOT_EQUALS]="not_equals",x[f.DAOQueryBuilder.HIGHEROREQUALS]="higherorequals",x[f.DAOQueryBuilder.HIGHER]="higher",x[f.DAOQueryBuilder.INCLUDES]="includes",x[f.DAOQueryBuilder.STARTS]="starts",x[f.DAOQueryBuilder.ENDS]="ends";var E=function(){function e(t,r){a(this,e),this.path=t,this.pk=r}return u(e,[{key:"createInsert",value:function(e){return"".concat(this.path,"/")}},{key:"createUpdate",value:function(e){return"".concat(this.path,"/").concat(e[this.pk])}},{key:"createDelete",value:function(e){return"".concat(this.path,"/").concat(e[this.pk])}},{key:"createFind",value:function(e){var t=e.filter,r=e.order,n=e.limit,a=e.aggregate,u=Object.getOwnPropertySymbols(t),s=[];if(u.length>0){this.reference;for(var i=0;i<u.length;i++){var o=t[u[i]];o.type===f.DAOQueryBuilder.RANGE&&(s.push("".concat(o.field,"[").concat(x[f.DAOQueryBuilder.HIGHEROREQUALS],"]=").concat(o.value)),s.push("".concat(o.field,"[").concat(x[f.DAOQueryBuilder.LOWEROREQUALS],"]=").concat(o.to))),o.type===f.DAOQueryBuilder.GROUP_START||o.type===f.DAOQueryBuilder.GROUP_END||o.type===f.DAOQueryBuilder.AND||o.type===f.DAOQueryBuilder.OR?s.push("".concat(o.field,"[").concat(o.value,"]")):s.push("".concat(o.field,"[").concat(x[o.type],"]=").concat(o.value))}}for(var c=[],h=0;h<r.length;h++){var l=r[h];c.push(("desc"===l.direction?"^":"")+l.field)}return a&&s.push(a.toURL().join("&")),c.length&&s.push("sort=".concat(c.join(","))),n&&n.from&&n.to?s.push("offset=".concat(n.from,"&limit=").concat(n.to)):n&&n.to?s.push("offset=0&limit=".concat(n.to)):n&&n.from&&s.push("offset=".concat(n.from)),"".concat(this.path,"?").concat(s.join("&"))}}]),e}();E.ACTIVE=E;var T=function(e){function t(e,r,n){var u;return a(this,t),(u=o(this,c(t).call(this,e,n))).urlMaker=new E.ACTIVE(r,n),u}var s,i,h;return l(t,e),u(t,[{key:"createDAO",value:function(){var e=this;return(function(t){function r(){return a(this,r),o(this,c(r).call(this,e.name,e.pk))}return l(r,t),r}(w))}},{key:"find",value:(h=n(r.mark((function e(t,n){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",O.execute(this.urlMaker.createFind(t),t,k.GET,n).then((function(e){if(200===e.status)return e.data;throw new Error(p.get(e,"rest.data","Failed to execute request"))})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"save",value:(i=n(r.mark((function e(t,n){var a;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t[this.pk]?this.urlMaker.createUpdate(t):this.urlMaker.createInsert(t),e.abrupt("return",O.execute(a,t,t[this.pk]?k.PUT:k.POST,n).then((function(e){if(200===e.status)return e.data;throw new Error(p.get(e,"rest.data","Failed to execute request"))})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"remove",value:(s=n(r.mark((function e(t,n){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",O.execute(this.urlMaker.createDelete(t),t,k.DELETE,n).then((function(e){if(200===e.status)return e.data;throw new Error(p.get(e,"rest.data","Failed to execute request"))})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})}]),t}(f.StoreStrategy);e.RESTMethod=k,e.RESTConnection=O,e.RESTDAO=w,e.RESTSessionStrategyRAW=g,e.RESTSessionStrategy=S,e.RESTStoreStrategy=T,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=rrpm.js.map
